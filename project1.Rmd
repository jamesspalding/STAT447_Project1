---
title: "STAT547 Project 1"
author: "James Spalding & Ryan Winder"
date: "2024-02-27"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
#packages
library(tidyverse)
library(readxl)
library(DescTools)
```

```{r}
##### Data cleaning #####
#data
patients = read_excel("patients.xlsx")[,1:5]
parkdata = read.csv("parkinsons.csv")

#patients data:
#clean up non-numeric values
#only a few incorrect values, so manually entering data.
patients[2,5] = ".25"
patients[6,5] = "1.5"
patients[12,5] = "4.5"
patients[15,5] = "5.5"
patients[24:31,4:5] = NA
patients$`Stage (H&Y)` = as.numeric(patients$`Stage (H&Y)`)
patients$`Years since diagnosis` = as.numeric(patients$`Years since diagnosis`)

#remove "healthy" from names
subnames = gsub(" \\(.*", "", patients$'Subject code')
patients$`Subject code` = subnames
colnames(patients)[1] = "name"


#parkdata: 
#makes names column match format of patients data
parknames = gsub("p.*S", "S", parkdata$name)
parknames = gsub("_.", "", parknames)

parkdata$name = parknames


##### Joining Tables #####
fulldata = right_join(patients, parkdata, by = "name")
fulldata = fulldata[!is.na(fulldata$Sex), ] #removing cases without a match in patients df
```

```{r}
#function to create descriptive tables
groupDescriptives = function(func){
  df = data.frame(nrow = 31)
  for (i in 6:22) {
    df = cbind(df, 
                   tapply(fulldata[[i]], fulldata[["name"]], func)
                   )
  }
  df = df[,2:18]
  names(df) = names(fulldata)[6:22]
  return(df)
}

meanDF = groupDescriptives("mean")
sdDF = groupDescriptives("sd")
medDF = groupDescriptives("median")
minDF = groupDescriptives("min")
maxDF = groupDescriptives("max")
```

# Introduction

Our goal in this paper is to assess possible connections in voice data with the diagnosis of Parkinson's Disease (PD). We were given a csv file containing all of the voice measurements from 31 people, where 23 have Parkinson's. We were also given further information about each patient in an xlsv file, which we intend to condense both into one table to better analyze the connections between the voice measurements with further personal information. 

In order to best join the tables and run appropriate statistics on the data, we intend to average the voice measurements for each variable and then merge the two tables by joining columns. Once here, we intend to explore the data, and then run statistics of interest, one of which is identifying if there are differences in the age that men and women are diagnosed with PD. The last thing of interest is we will look to identify what variables from the voice measurements could be statistically significant in identifying patients who have PD. By doing so, we will look at if there is a signficant difference between the means, variances, and medians of those that have and do not have PD across all voice measurements.
    
# Exploring The Data

The data used in this study was composed of 31 patients, 23 of which have tested positive for PD and the remaining 8 at risk. Each of these patients have taken various tests to determine their scores in the following variables mentioned in the above below:

```{r}
#Using a few packages to create pretty tables
library(gt)
library(gtExtras)

Term = c("Sex","Age","Stage","Diagnosis", "Fo","Fhi", "Flo", "Jitter", "Shimmer", "NHR/HNR", "Status")
Definition = c("Biological sex (M/F)","Age in years","Severity of Parkenson's disease (1-4)", "Years since first positive diagnosis (If applicable)", "Average vocal fundamental frequency (Hz.)", "Maximum vocal fundamental frequency (Hz.)", "Minimum vocal fundamental frequency (Hz.)","Measure of variation in fundamental frequency", "Measure of variation in amplitude", "Measure of ratio of noise to tonal components in the voice", "Presence of PD in patient (Y/N)")

records = t(as.data.frame(rbind(Term, Definition)))
records = as.data.frame(records)
records %>%
  gt() %>%
  gt_theme_nytimes()
```

Throughout this study, we will use these terms to search for connections between the various measures of voice and the presence of PD in patients.


```{r, eval = F}
#check for normality
shapiroP = c()
for(i in names(fulldata)[3:21]){
  shapiroP = c(shapiroP, shapiro.test(fulldata[[i]])$p.value)
}

which(shapiroP>.05) #none of the variables are normally distributed.
```

By running the Shapiro-Wilkes test for normality on each of the 19 numeric values, we have determined that none of the variables are normally distributed, and thus we must use nonparametric approaches for all analysis conducted.

**Do the scores differ by sex?**

The first test ran was to determine whether sex has an effect on mean values for the tests. In order to find this information, we must conduct a series of permutation tests; one for each of the variables. 1,000 permutations were used for each.

**P Values:**

```{r, eval=T}
pvalues = c()
ospvalues = c()
for(z in 3:22){

  dat1 = filter(fulldata, Sex == "M")[[z]]
    
  dat2 = filter(fulldata, Sex == "F")[[z]]
  
  m=length(dat1)
  n=length(dat2)
  tot=m+n
  Dobs=mean(dat1)-mean(dat2)
  
  nperm=1000
  Dperm=rep(0,nperm) 
  alldat=c(dat1,dat2)
  
  for(i in 1:nperm){
    index=sample(1:tot,m)
    newdat1=alldat[index]
    newdat2=alldat[-index]
    Dperm[i]=mean(newdat1)-mean(newdat2)
  }
  
  pvalue=sum(abs(Dperm)>=abs(Dobs))/nperm #means not equal
  onesidepval = sum(Dperm>=Dobs)/nperm #male means higher than female means
  ospvalues = c(ospvalues, onesidepval)
  pvalues = c(pvalues, pvalue)
  
}
round(pvalues[-c(2,3)],1)
#round(ospvalues[-c(2,3)],1)
```

With an $\alpha$ value of .05, we can say that the mean scores for min, max, and average vocal fundamental frequency, one of the jitter ratings, and diagnosis status significantly differ between genders. Furthermore, if we conduct the same tests but with a one-sided hypothesis, we can conclude that females have an overall higher mean vocal fundamental frequency than males, and that males have a higher mean score in the jitter test and are more frequently diagnosed than females.

**Is there a difference in diagnosis between sexes?**

Zooming in on the above observation that males appear to be more frequently diagnosed than females, we can perform the McNemar's test on the data to confirm or deny this observation.

```{r}
patients2 <- patients %>%
  arrange(name)

combined_data <- cbind(patients2,meanDF[,-1])
attach(combined_data)

first_test <- data_frame(
  Healthy = c(sum(Sex == "M" & status == 0), sum(Sex == "F" & status == 0)),
  Unhealthy = c(sum(Sex == "M" & status == 1), sum(Sex == "F" & status == 1)),
  Sex = c("Male", "Female")
)

first_test_matrix <- matrix(c(as.numeric(first_test[1,1]),
                              as.numeric(first_test[2,1]),
                              as.numeric(first_test[1,2]),
                              as.numeric(first_test[2,2])),nrow=2)


#mcnemar.test(first_test_matrix) #p-value of .0291, so we reject H0
                                # We can then claim that the probability of getting
                                # parkinson's is not the same for both Men and Women

first_test %>%
  gt() %>%
  gt_theme_nytimes()
```

$$\chi^2 = 4.76 \; \; \; P = 0.03$$

As the p-value is below our $\alpha$ value of .05, we can once again conclude that there is a difference in the amount of diagnoses between sexes.

**Does age make a difference?**

We conducted the same permutation tests as used in the sex tests, but with patients aged 45-65 and 66-85 grouped instead of sex.

P-Values:

```{r, eval = T}
pvalues = c()
ospvalues = c()
for(z in 6:22){

  dat1 = filter(fulldata, Age <= 65)[[z]]
    
  dat2 = filter(fulldata, Age > 65)[[z]]
  
  m=length(dat1)
  n=length(dat2)
  tot=m+n
  Dobs=mean(dat1)-mean(dat2)
  
  nperm=1000
  Dperm=rep(0,nperm) 
  alldat=c(dat1,dat2)
  
  for(i in 1:nperm){
    index=sample(1:tot,m)
    newdat1=alldat[index]
    newdat2=alldat[-index]
    Dperm[i]=mean(newdat1)-mean(newdat2)
  }
  
  pvalue=sum(abs(Dperm)>=abs(Dobs))/nperm 
  onesidepval = sum(Dperm>=Dobs)/nperm 
  ospvalues = c(ospvalues, onesidepval)
  pvalues = c(pvalues, pvalue)
  
}
round(pvalues[-c(2,3)],1)
#round(ospvalues[-c(2,3)],1)
```

With an $\alpha$ level of .05, we can conclude that there is a significant difference between means for every variable, excluding average vocal fundamental frequency. With a one sided test, we can say that the older group has higher values for every variable besides NHR rating, where the younger group has higher mean values.

```{r}
plot(fulldata)
```

```{r}
ggplot(data = fulldata, aes(Age, Shimmer.APQ5, color = Sex))+
  geom_point()
```

# Statistical Methods

```{r, include=FALSE}
difference_function <- function(x, test_to_run = mean) {
  
  function_list <- list(
    Healthy = c(x[status == 0]),
    Unhealthy = c(x[status == 1])
  )
  
  dat1 <- function_list$Healthy
  dat2 <- function_list$Unhealthy
  
  m=length(function_list$Healthy)
  n=length(function_list$Unhealthy)
  tot=m+n
  Dobs=test_to_run(dat1)-test_to_run(dat2)

  nperm=1000
  Dperm=rep(0,nperm)
  alldat=c(dat1,dat2)

  for(i in 1:nperm){
    index=sample(1:tot,m)
    newdat1=alldat[index]
    newdat2=alldat[-index]
    Dperm[i]=test_to_run(newdat1)-test_to_run(newdat2)
  }

  pvalue=sum(abs(Dperm)>=abs(Dobs))/nperm
  pvalue
}
```

We discovered earlier how the number of men and women that are diagnosed with PD is statistically different. We are now interested if there is a statistical difference between the age at which men and women are diagnosed with PD, along with if there is a difference in the variability between when men and women are diagnosed. First, we will run a right-tailed two-sample simulated permutation test to see if the mean age at which women are diagnosed with PD is statistically greater than men. The hypothesis is given by:
    $$\(H_0: \mu_{F} = \mu_{M}\)$$
    $$\(H_a: \mu_{F} > \mu_{M}\)$$
    
```{r, include=FALSE}
M_year_of_diagnosis = c()
F_year_of_diagnosis = c()
j = 1
k = 1

for(i in 1:31) {
  if(!is.na(`Years since diagnosis`[i])) {
    if(Sex[i] == "M") { M_year_of_diagnosis[j] = Age[i] - `Years since diagnosis`[i]
                     j = j + 1}
    if(Sex[i] == "F") { F_year_of_diagnosis[k] = Age[i] - `Years since diagnosis`[i]
                     k = k + 1}
  }
}

dat1 = F_year_of_diagnosis
dat2 = M_year_of_diagnosis

m=length(dat1)
n=length(dat2)
tot=m+n
Dobs=mean(dat1)-mean(dat2)

nperm=1000
Dperm=rep(0,nperm)
alldat=c(dat1,dat2)

for(i in 1:nperm){
  index=sample(1:tot,m)
  newdat1=alldat[index]
  newdat2=alldat[-index]
  Dperm[i]=mean(newdat1)-mean(newdat2)
}
```

```{r, echo=FALSE}
Dobs
sum(Dperm>=Dobs)/nperm
```

The Dobs from the two-sample simulated permutation test is 0.2589, and the test gives a corresponding $\p-val$ of around 0.464. Therefore we fail to reject $\H_0$ at the .05 level. We can conclude that we do not have enough evidence to say that women are diagnosed with PD at a later age than men.

For testing for a difference between men and women in the variability of diagnosis we will use a two-sided Siegel Tukey Test with an $\alpha$ level of .05. Then, we will check the result of that test with another two-sample simulated permutation test for the variances. For the Siegel Tukey test we have the following hypothesis: 
    $$\(H_0: \sigma_{M}^{2} = \sigma_{F}^{2}\)$$
    $$\(H_a: \sigma_{M}^{2} /= \sigma_{F}^{2}\)$$

```{r, echo=FALSE}
# Returns a p-value of .00695. We can reject H0. 
# We have significant evidence that the variability between men and women
# differ for when they are diagnosed with Parkinsons
SiegelTukeyTest(M_year_of_diagnosis,F_year_of_diagnosis,alternative="two.sided")
```

The Siegel-Tukey test returned a test statistic of 32, and a corresponding $\p-val$ of 0.00695. We can then reject $\H_0$ at the .05 level. We can than conclude that we have significant evidence to suggest that the variance for at what age men and women are diagnosed with PD is different. 
We will then run another test for this using the simulated permutation test to see if the variability for the age women are diagnosed with PD is greater than that for men. We will be using the two-sample simlulated permutation test for this because it has a greater power than the Siegel Tukey test. The hypothesis for this test is as follows:
    $$\(H_0: \sigma_{F}^{2} = \sigma_{M}^{2}\)$$
    $$\(H_a: \sigma_{F}^{2} > \sigma_{M}^{2}\)$$

```{r, include=FALSE}
dat1 = F_year_of_diagnosis
dat2 = M_year_of_diagnosis

m=length(dat1)
n=length(dat2)
tot=m+n
Dobs=var(dat1)-var(dat2)

nperm=1000
Dperm=rep(0,nperm)
alldat=c(dat1,dat2)

for(i in 1:nperm){
  index=sample(1:tot,m)
  newdat1=alldat[index]
  newdat2=alldat[-index]
  Dperm[i]=var(newdat1)-var(newdat2)
}
```

```{r, echo=FALSE}
Dobs
sum(Dperm >= Dobs)/nperm
```

The two-sample simulated permutation test gives a Dobs of 215.469, and a corresponding $\p-val$ of around 0.002. We can reject $\H_0$ at the .05 level. We can then conclude with this test that we have significant evidence to suggest that the variance for when women are diagnosed with PD is greater than it is for men.


```{r}
explanatory_variables <- data.frame(
  variables = c("MDVP.Fhi.Hz.", "MDVP.Flo.Hz.", "MDVP.Jitter...", "MDVP.Jitter.Abs.",
                "MDVP.RAP", "MDVP.PPQ", "Jitter.DDP", "MDVP.Shimmer", "MDVP.Shimmer.dB.",
                "Shimmer.APQ3", "Shimmer.APQ5", "MDVP.APQ", "Shimmer.DDA",
                "NHR", "HNR"))
p_values_mean <- c()
p_values_var <- c()
p_values_median <- c()

for(i in 6:20) {
  p_values_mean[i-5] <- difference_function(combined_data[,i])
  p_values_var[i-5] <- difference_function(combined_data[,i], var)
  p_values_median[i-5] <- difference_function(combined_data[,i], median)
}


permutation_tests <- data.frame(
  Variable = explanatory_variables$variables,
  Pval_mean = p_values_mean,
  Pval_var = p_values_var,
  Pval_median = p_values_median
)

permutation_tests
```


# Results

```{r}

```

